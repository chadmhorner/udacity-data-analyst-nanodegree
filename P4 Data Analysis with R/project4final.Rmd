#Examining Political Contributions in New Jersey During the 2016 Election Cycle  
by Chad Horner
========================================================

This project will examine the FEC (Federal Elections Commission) contribution data for the 2016 election cycle, focusing specifically on the state of New Jersey.

```{r global_options,  message=FALSE, warning=FALSE, include = FALSE}
knitr::opts_chunk$set(echo=FALSE) #set echo to FALSE for all code chunks
knitr::opts_chunk$set(message =FALSE)
knitr::opts_chunk$set(warning =FALSE)
```

```{r echo=FALSE, packages}
library(ggplot2)
library(dplyr)
library(scales)
library(gender) #using for gender section
library(genderdata) #using for gender section
library(hash) #using for gender section
library(jsonlite) #for republican polling data
library(reshape2) #for republican polling data
library(zipcode) #for map/zipcode
library(maps) #for map/zipcode
library(ggmap) #for map/zipcode
```



```{r load}
# data source: http://fec.gov/disclosurep/pnational.do
setwd('/Users/chadhorner/Documents/OneDrive/Udacity/P4')
newjersey = read.csv('newjersey.csv')
newjersey$X. = NULL #eliminate extra column
```

### Initial Summary

```{r initial summary}
dim(newjersey) #dimensions
summary(newjersey) #summary stats
str(newjersey) #structure
```

A simple initial analysis shows us that we have 170,293 observations of 18 variables. The variables that appear to be of greatest interest are:  
- *cand_nm*: name of candidate  
- *contbr_nm*: name of contributor  
- *contbr_city*: city of contributor  
- *contbr_zip*: zip code of contributor  
- *contbr_employer*: employer of contributor  
- *contbr_occupation*: occupation of contributor  
- *contb_receipt_amt*: $ amount of contribution  
- *contb_receipt_dt*: date of contribution  
- *form_tp*: type of form (SA17A, SA18, or SB28A)  
- *election_tp*: which race this was for (primary or general)  

A few questions I will seek to answer in this analysis, using these original variables:  
- how much in total contributions did each candidate receive?  
- was the distribution of contributions different across industries? (e.g. university workers vs. bank workers)  
- how did contributions evolve over time?  

There are a couple useful variables we can create in a straightforward manner:  
- *cand_gender*: gender of the candidate  
- *cand_party*: party of the candidate  

```{r new variables 1}
candidate_rename <- function(candidate) {
  pos <- regexpr(',', candidate)[1] #find position of comma
  return(substr(candidate, 1, pos-1))
}

newjersey['cand_nm'] <- apply(newjersey['cand_nm'], 1, candidate_rename)

newjersey$cand_nm <- factor(newjersey$cand_nm)

newjersey$newdates <- as.Date(newjersey$contb_receipt_dt,
                             format = '%d-%b-%y')

#candidate gender
assign_candidate_gender <- function(candidate) {
  gender <- 'M'
  if ((candidate == 'Clinton') | (candidate == 'Fiorina')) {
    gender <- 'F'
  } 
  return(gender)
}

newjersey$cand_gender <- factor(apply(newjersey['cand_nm'], 1,
                                      assign_candidate_gender))

#candidate party
assign_candidate_party <- function(candidate) {
  if (candidate == 'Johnson') {
    return('Libertarian')
  } else if (candidate == 'Stein') {
    return('Green')
  } else if (candidate == 'McMullin') {
    return('Independent')
  } else if (candidate %in% c('Clinton', 'Sanders', 'O\'Malley', 
                              'Webb', 'Lessig')) {
    return('Democratic')
  } else {
    return('Republican')
  }
}

newjersey$cand_party <- factor(apply(newjersey['cand_nm'], 1,
                                     assign_candidate_party))
```


However, there are additional questions I would like to answer. I'd like to look at the relationship between the gender of the donors and the distribution of contributions - but the gender of the donor is not a variable contained in the data. I'd also like to determine if the distribution is different in high-income areas vs. low-income areas. To assist in answering these questions, as well as some others, I created some new variables with the assistance of outside data.

### Gender of Contributors
To create the variable *contbr_gender* I used the [**'gender'** package. ](https://cran.r-project.org/web/packages/gender/gender.pdf) This package uses data from the Social Security Administration to predict the gender of a given first name. While it obviously is not completely accurate (for example, I have a female friend named Kellen, yet this method assigns Kellen as a male name with 91% confidence), and in a small percentage of cases encounters names that it cannot assign one way or the other, for most names there is little ambiguity. 

The **gender** function takes a second or more to run, and we have over 100,000 entries in our dataset! To speed this up, I created a data frame with only unique contributor names. From here, I created a variable *first_name* that is solely the first names, and again cut down to a unique list of names. I then ran the gender function on all of these names, and created a hash table using the [**'hash'** package](https://cran.r-project.org/web/packages/hash/hash.pdf) to relate the names to the gender. From there it was much more efficient to return to the master dataframe and assign a gender to each entry. Instead of 170,293 calls of **gender**, we had only 5,079. 

```{r gender}
get_first_name <- function(contrib) {
  pos <- regexpr(',', contrib)[1] #find position of comma
  first <- substr(contrib, pos + 2, nchar(contrib))
  space <- regexpr(' ', first)[1] #in cases with space in name
  if (space > -1) {
    first <- substr(first, 1, space-1)
  }
  return(first)
}
 
assign_contrib_gender_firstname <- function(contrib_firstname) {
  year_min = 1932 #default
  year_max = 1998 #2016 - 18 years (nobody younger than this is giving money)
  return(gender(contrib_firstname, years = c(year_min, year_max))$gender)
}

get_gender <- function(name, hash) {
  return(hash[[name]])
}

#first get unique first names:
all_contbrs <- data.frame(unique(newjersey$contbr_nm)) #df of unique contbrs
colnames(all_contbrs) <- c('contbr_nm')
all_contbrs$first_name <- apply(all_contbrs['contbr_nm'], 1,
                                get_first_name)
all_firsts <- data.frame(unique(all_contbrs$first_name))
colnames(all_firsts) <- c('first_name')
```


```{r eval=FALSE}
#this is the code that creates the data frame from scratch. 
#this will take ~30 minutes for ~5000 names
nametogender$gender <- apply(nametogender['first_name'], 1,
                             assign_contrib_gender_firstname)
```

```{r gender part 2}
nametogender <- read.csv('firstname_to_gender.csv')
gender_hash <- hash(nametogender$first_name, nametogender$gender)

#now hash to assign to master df
newjersey$first_name <- apply(newjersey['contbr_nm'], 1,
                              get_first_name)
#need to cut out the entries wihtout a first name (there are only a few)
newjersey <- newjersey[newjersey['first_name']!='',]
newjersey$contbr_gender <- apply(newjersey['first_name'], 1, 
                                 get_gender, hash = gender_hash)
newjersey$contbr_gender <- factor(newjersey$contbr_gender)

```

### Income data
The dataset doesn't contain much information on the individual contributors aside from their location and occupation/employer. In order to see if there are relationships between income and contributions, I grouped together a few sets of data. The first was [tax data from the IRS](https://www.irs.gov/uac/soi-tax-stats-individual-income-tax-statistics-zip-code-data-soi), which gave me Adjusted Gross Income (along with a lot of other statistics) for each zip code. I merged this data with a table of population by zip code ([courtesy of Splitwise](https://blog.splitwise.com/2013/09/18/the-2010-us-census-population-by-zip-code-totally-free/)) and then calculated average AGI per capita for each zip code, and added that variable to the table. It'd be great if we had income data for the individual contributors, but this is the most precise we can get with what information we are given. 

```{r income}
#read in income data and subset to newjersey
income <- read.csv('zipcode2014/14zpallnoagi.csv')
njincome <- subset(income, STATE == 'NJ')
#read in zip code data
zipcodes <- read.csv('censuszipcode.csv')
colnames(zipcodes) <- c('zip', 'population')

#make hash of zip code data
ziphash <- hash(zipcodes$zip, zipcodes$population)
get_population <- function(zip, hash) {
  return(hash[[toString(zip)]])
}

njincome$population <- apply(njincome['ZIPCODE'], 1, get_population,
                           hash = ziphash)
njincome <- subset(njincome, population != 'NULL')
njincome$population <- unlist(njincome$population)

#get AGI per capita
njincome$agiPC <- as.numeric(njincome$A00100)/as.numeric(njincome$population)

#clean up zip codes in contribution data
clean_zip <- function(zip) {
  zip <- toString(zip)
  if (nchar(zip) == 0) { #for blank rows
    return(zip)
  }
  if (nchar(zip) == 9) { #zip+4 w/ non-0 leading digit
    return(as.numeric(substr(zip, 1, 5)))
  } else if (nchar(zip) == 8) { #zip+4 w/ 0 as leading digit
    return(as.numeric(substr(zip, 1, 4)))
  } else { #other stuff
    return(as.numeric(zip))
  }
}

#create cleaned_zips
newjersey$cleaned_zips <- factor(apply(newjersey['contbr_zip'], 1,
                                       clean_zip))

slimnjincome <- njincome[c('ZIPCODE','A00100','population',
                           'agiPC')]

njmerged <- merge(newjersey, slimnjincome, 
                      by.x = 'cleaned_zips', by.y = 'ZIPCODE')
#want to defactor these:
njmerged$population <- as.numeric(as.character(njmerged$population))
njmerged$agiPC <- as.numeric(as.character(njmerged$agiPC))
```

### Cleaning the data
Now that we have created all of the variables for the analysis, we'll want to split up the data into some different subsets and clean it up a bit. 

We'll cut out contributions related to the 2020 election cycle or those without any value in *election_tp*. We will only be examining individual contributions (those on form SA17A, *form_tp* == 'SA17A'), and not incorporating transfers between committees (form SA18) or refunds (form SB28A). Individual contributions make up roughly 5/6 of the entries in the dataset to begin with, and given the lack of documentation on the use of the different form types it is far more straightforward to stick to just the individual contributions.

There are some negative values for *contb_receipt_amt* remaining in this data, which presumably should have been classified as refunds or transfers. We will cut these out. 

And finally, we'll create two subsets - one of data from the primaries, and one for the general.

```{r cleaning and subsetting, echo = TRUE}
#cleaning
njmerged <- subset(njmerged, election_tp == 'G2016' | election_tp == 'P2016')

#look at individual contributions only
sa17a <- subset(njmerged, form_tp == 'SA17A' & contb_receipt_amt > 0)

#makes sense to have one set of primary data 
#and one set of general election data
primaries <- subset(sa17a, election_tp == 'P2016')
general <- subset(sa17a, election_tp == 'G2016')
```


```{r color scales}
#these will be used throughout
parties <- c('Republican', 'Democratic', 'Independent',
             'Libertarian', 'Green')
candidates <- c('Trump', 'Clinton', 'McMullin', 'Johnson', 'Stein')
incomegroups <- c('high', 'middle', 'low')
partycolors <- c('firebrick', 'dodgerblue', 'darkorchid',
                 'goldenrod', 'forestgreen')
candcolors <- c('firebrick', 'dodgerblue', 'darkorchid',
                'goldenrod', 'forestgreen')
incomecolors <- c('royalblue', 'limegreen', 'orangered')
names(candcolors) <- candidates
names(partycolors) <- parties
names(incomecolors) <- incomegroups
```


## Initial observations

The primary focus of this analysis will be on comparing the contributions received by different candidates across different subsets of the population. We'll begin with a few simple graphs showing the distribution of the $ amount of the contributions. 

```{r distribution of contri}
ggplot(aes(x = contb_receipt_amt), 
       data = sa17a) + 
  geom_histogram(binwidth = 50) +
  ggtitle('Histogram of Contributions') + 
  labs(x = '$ contribution amount', y = 'count') + 
  theme(plot.title = element_text(face = 'bold', size = 16, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10))
```

```{r }
ggplot(aes(x = contb_receipt_amt), 
       data = sa17a) + 
  geom_histogram(binwidth = 50) +
  coord_cartesian(xlim = c(0, 3000)) +
  ggtitle('Histogram of Contributions') + 
  labs(x = '$ contribution amount', y = 'count') + 
  theme(plot.title = element_text(face = 'bold', size = 16, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10))
```

```{r distribution of contributions}
ggplot(aes(x = contb_receipt_amt), 
       data = sa17a) + 
  geom_histogram(binwidth = 1) +
  coord_cartesian(xlim = c(0, 100)) +
  ggtitle('Histogram of Contributions') + 
  labs(x = '$ contribution amount', y = 'count') + 
  theme(plot.title = element_text(face = 'bold', size = 16, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10))
```

```{r}
ggplot(aes(x = contb_receipt_amt), 
       data = sa17a) + 
  geom_freqpoly(binwidth = 10) +
  coord_cartesian(xlim = c(0, 3000)) +
  scale_y_continuous(label = comma) +
  ggtitle('Frequency Polygram of Contributions') + 
  labs(x = '$ contribution amount', y = 'count') + 
  theme(plot.title = element_text(face = 'bold', size = 16, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10))
```

We begin with a histogram of the $ amount of the contributions; it is immediately clear that most of the contributions are clustered to the very left end of the graph, and all are less than $3000 save a few exceedingly large donations.  

The second plot provides a bit more clarity, but mainly serves to make it clear that most contributions are less than $100. We also see a tendency towards giving in round amounts - there are small bumps at $1000, $2000, and $2700, the latter being the maximum donation to an individual's campaign. 

The final plot, zoomed in to show only donations up to $100, once again demonstrates the propensity for giving in round amounts - the top 5 amounts are $5, $10, $25, $50, and $100.  

### Total Contributions per Candidate
The two plots below break out total contributions received for each candidate, with the first set of graphs showing the # of contributions received and the second showing $ amount. Each plot is faceted by election - the general on the left, the primary on the right. 

```{r contribs by candidate by election}
ggplot(aes(x = cand_nm),
       data = sa17a) + 
  geom_histogram(stat = 'count', aes(fill = cand_party)) +
  facet_wrap(~election_tp) +
  scale_y_continuous(labels = comma) +
  scale_fill_manual(name = 'candidate party', values = partycolors) +
  ggtitle('# of Contributions to Each Candidate, by Election') + 
  labs(x = 'candidate name', y = '# of contributions') + 
  theme(plot.title = element_text(face = 'bold', size = 16, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10, angle = 60))
```

```{r}
#bar graph of total $ contribute to each candidate
by_candidate_totals <- group_by(sa17a, cand_nm, election_tp)
contb_totals <- summarise(by_candidate_totals,
                                   total = sum(contb_receipt_amt),
                                   n = n())
contb_totals$cand_party <- factor(apply(contb_totals['cand_nm'], 1,
                                     assign_candidate_party))

ggplot(aes(x = cand_nm, y = total), 
       data = contb_totals) +
  geom_bar(stat = 'identity', position = position_dodge(), 
           aes(fill = cand_party)) + 
  facet_wrap(~election_tp) +
  scale_y_continuous(labels = comma) +
  scale_fill_manual(name = 'candidate party', values = partycolors) +
  ggtitle('Total $ Amount of Contributions to Each Candidate') + 
  labs(x = 'candidate name', y = '$ amount of contributions') + 
  theme(plot.title = element_text(face = 'bold', size = 16, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10, angle = 60))
```

And for some additional clarity, here are the two primary graphs zoomed in on the lower areas:

```{r contribs by candidate by election zoom}
ggplot(aes(x = cand_nm),
       data = primaries) + 
  geom_histogram(stat = 'count', aes(fill = cand_party)) +
  scale_y_continuous(labels = comma) +
  scale_fill_manual(name = 'candidate party', values = partycolors) +
  ggtitle('# of Contributions to Each Candidate in Primaries') + 
  labs(x = 'candidate name', y = '# of contributions') + 
  theme(plot.title = element_text(face = 'bold', size = 16, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10, angle = 60)) +
  coord_cartesian(ylim = c(0,10000))
```

```{r}
#bar graph of total $ contribute to each candidate
by_candidate_totals <- group_by(primaries, cand_nm, election_tp)
contb_totals <- summarise(by_candidate_totals,
                                   total = sum(contb_receipt_amt),
                                   n = n())
contb_totals$cand_party <- factor(apply(contb_totals['cand_nm'], 1,
                                     assign_candidate_party))

ggplot(aes(x = cand_nm, y = total), 
       data = contb_totals) +
  geom_bar(stat = 'identity', position = position_dodge(), 
           aes(fill = cand_party)) +
  scale_y_continuous(labels = comma) +
  scale_fill_manual(name = 'candidate party', values = partycolors) +
  ggtitle('Total $ Amount of Contributions to Each Candidate in Primaries') + 
  labs(x = 'candidate name', y = '$ amount of contributions') + 
  theme(plot.title = element_text(face = 'bold', size = 12, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10, angle = 60)) +
  coord_cartesian(ylim = c(0,1000000))
```

#####Takeaways:  
- both Sanders and Clinton received more primary contributions on their own than all of the other candidates combined  
- amongst the Republicans, Ted Cruz received by far the highest number of individual contributions. however, Chris Christie was the clear leader in terms of $ received, with nearly $4,000,000, approaching Clinton's $5,000,000 total  
- using the graphs together, it is easy to see some trends: Christie and Bush clearly received a small number of high-dollar contributions, whereas candidates like Sanders, Cruz, and Carson relied on a high number of small-dollar donations   

### Distribution of Contributions Across Candidates

In this section, we'll dive a bit deeper into how the contributions were distributed across the candidates. This next plot is a boxplot, showing the size of the contributions on the y-axis.


```{r}
ggplot(aes(y = contb_receipt_amt, x = cand_nm), 
       data = sa17a) + 
  geom_jitter(alpha = .3, width = .2, aes(color = cand_party)) +
  geom_boxplot(aes(fill = cand_party), outlier.color = NA) +
  scale_fill_manual(values = partycolors, name = 'candidate party') +
  scale_color_manual(values = partycolors, guide = FALSE) +
  ggtitle('Contributions to Each Candidate') + 
  labs(x = 'candidate name', y = '$ amount of contributions') + 
  theme(plot.title = element_text(face = 'bold', size = 16, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10, angle = 60))
```

To make it a bit easier to draw conclusions, below are two additional plots: first, the same plot, but zoomed in on the lower area; second, with the natural log of the contribution amount on the y axis

```{r}
ggplot(aes(y = contb_receipt_amt, x = cand_nm), 
       data = sa17a) + 
  geom_jitter(alpha = .3, width = .2, aes(color = cand_party)) +
  geom_boxplot(aes(fill = cand_party), outlier.color = NA) +
  scale_fill_manual(values = partycolors, name = 'candidate party') +
  scale_color_manual(values = partycolors, guide = FALSE) +
  ggtitle('Contributions to Each Candidate') + 
  labs(x = 'candidate name', y = '$ amount of contributions') + 
  theme(plot.title = element_text(face = 'bold', size = 16, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10, angle = 60)) +
  coord_cartesian(ylim = c(0, 3000))
```

```{r}
ggplot(aes(y = log(contb_receipt_amt), x = cand_nm), 
       data = sa17a) + 
  geom_jitter(alpha = .3, width = .2, aes(color = cand_party)) +
  geom_boxplot(aes(fill = cand_party), outlier.color = NA) +
  scale_fill_manual(values = partycolors, name = 'candidate party') +
  scale_color_manual(values = partycolors, guide = FALSE) +
  ggtitle('Contributions to Each Candidate') + 
  labs(x = 'candidate name', y = 'ln($ amount of contributions)') + 
  theme(plot.title = element_text(face = 'bold', size = 16, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10, angle = 60)) +
  coord_cartesian(ylim = c(0, 9.5))
```

#####Takeaways:  
- Clinton and Sanders have the lowest median donation amounts, and their IQRs (interquartile ranges) are indistinguishably small on the larger-scale plots    
- there is a general trend across the two major parties that the Republicans exhibit a larger skew towards high-dollar donations  
- this isn't true for all Republicans though: amongst the Republicans, some candidates (Carson, Cruz, and Rand Paul, for example) relied primarily on smaller donations, while others (Bush, Christie, and Rick Perry) had many large donations  
- the three non-major party candidates, Gary Johnson, Jill Stein, and Evan McMullin, could have easily fit within the ranks of either party, though all had relatively low median contributions  
- Stein and McMullin were the only two candidates to not have any big money support - neither received a contribution of more than $500  

The next graph displays the median $ amount received by each candidate (primary elections only). The color of each candidate's bar is based on the number of contributions they received - darker means more, lighter means fewer. Above the bars is the actual number of contributions received.  

```{r median by candidate}
contb_stats <- summarise(by_candidate_totals,
                         total = sum(contb_receipt_amt),
                         mean = mean(contb_receipt_amt),
                         median = mean(contb_receipt_amt),
                         n = n())

ggplot(aes(x = cand_nm, y = median, label = n, fill = log(n)), 
       data = subset(contb_stats, n > 10)) + 
  #primaries only, add # of contributions above bars
  geom_bar(stat = 'identity', position = position_dodge()) + 
  scale_y_continuous(labels = comma) + 
  geom_text(aes(y = median + 100)) + 
  scale_fill_continuous(low = 'darkgoldenrod2',
                        high = 'midnightblue',
                        name = 'log(number of donations)') +
  ggtitle('Median $ Amount of Contributions to Each Candidate') + 
  labs(x = 'candidate name', y = 'median $ amount of contributions') + 
  theme(plot.title = element_text(face = 'bold', size = 12, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10, angle = 60))
```

The highest median contribution was received by ex-Gov. George Pataki, who never polled above 1% during the race. Bush, Christie, and Scott Walker had the highest numbers among the major candidates. Once again, Sanders and Clinton have the lowest median $ amount overall, while Carson, Cruz, and Rand Paul have the lowest of the Republicans.  

## Subsections of the Population

### Case Study: Industries
Switching gears a bit, here we will take a look at how contributions varied across different industry groups. The FEC data doesn't contain a field for industry of employment, but we'll use a subset of employers from four industries (education, banking, pharmaceuticals, and technology) as a proxy for their respective industries. 

Based on historical trends in political support and the positions of the respective candidates, I expected to see the following trends expressed in the data:  
- workers in the education industry will be predominantly liberal, and will also tend toward more 'elite' candidates across the spectrum (e.g. Clinton for Democrats, Bush for Republicans)  
- workers at the big banks (we used JPMorgan, Morgan Stanley, Bank of America, and Citigroup as our sample) will give more to Republicans, as they tend to be more favorable to the financial industry  
- workers in pharma should perhaps lean more Republican than average, as both leading Democratic candidates expressed an interest in putting a stop to rising drug prices  
- workers in tech will lean strongly Democratic, as they tend to be more liberal on social issues. they are also more likely to have a Libertarian bent to their giving  

```{r employers}
#creating subsets of data based on employers
universities <- c('RUTGERS UNIVERSITY', 'PRINCETON UNIVERSITY')
banks <- c('JPMORGAN CHASE', 'MORGAN STANLEY', 'BANK OF AMERICA', 
           'CITIGROUP')
pharma <- c('NOVARTIS', 'JOHNSON & JOHNSON', 'BAYER')
tech <- c('GOOGLE', 'FACEBOOK', 'MICROSOFT')

univ_donors <- subset(primaries, contbr_employer %in% universities)
bank_donors <- subset(primaries, contbr_employer %in% banks)
pharma_donors <- subset(primaries, contbr_employer %in% pharma)
tech_donors <- subset(primaries, contbr_employer %in% tech)

#want to see proportion of $ for each industry
add_proportion <- function(totals) {
  totals$proportion <- totals$total/sum(totals$total)
  return(totals)
}

#prep by-industry data
get_industry_totals <- function(industry_data, industry) {
  by_candidate <- group_by(industry_data, cand_nm)
  industry_totals <- summarise(by_candidate,
                            total = sum(contb_receipt_amt),
                            n = n(),
                            industry = industry)
  return(add_proportion(industry_totals))
}

univ_donors2 <- get_industry_totals(univ_donors, 'univ')
bank_donors2 <- get_industry_totals(bank_donors, 'bank')
pharma_donors2 <- get_industry_totals(pharma_donors, 'pharma')
tech_donors2 <- get_industry_totals(tech_donors, 'tech')

industries <- rbind(univ_donors2, bank_donors2, 
                    pharma_donors2, tech_donors2)

ggplot(aes(x = cand_nm, y = proportion, fill = industry),
       data = industries) + 
  geom_bar(stat = 'identity', position = position_dodge()) +
  ggtitle('Proportion of $ Contributed to Each Candidate per Industry') + 
  labs(x = 'candidate name', y = '$ amount of contributions within industry') + 
  theme(plot.title = element_text(face = 'bold', size = 16, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10, angle = 60))
```

#####Conclusions:  
- the proportion of donations going to Clinton are *remarkably* consistent across the four industry groups. in all cases it is between 65 and 75%  
- workers at the big banks are outliers in two ways: first, they give a far higher proportion to the Republican candidates (particularly Bush and Christie, though Christie is a special case here since we are looking at only New Jersey citizens). second, they give a far *lower* proportion to Bernie Sanders; this makes perfect sense: there was no bigger enemy of the banks in the campaign than Sanders, who had the most consistently populist message of all of the significant candidates  
- there are also a couple of fun outliers worth noting: about 5% of tech money went to Larry Lessig, a thoroughly inconsequential candidate who likely drew most of his support from the technocratic class (he is a Harvard professor who basically campaigned on a single issue: campaign finance reform). also, John Kasich's only donations in this subset of the data came from tech workers! 



###Contributions by Gender
In this section we examine contributions by gender. We subset the data to exclude the contributions from citizens whose name the gender algoirthm was not able to classify as either male or female. 

The first plot shows total $ contributions to each candidate in the primaries, split out by gender. From this plot we can draw two main conclusions: overall contributions were higher for men than for women, and women clearly showed a preference for Hillary Clinton. She was the only candidate (aside from Rick Santorum, who received a negligible amount of contributions) that received more from women than from men.  

```{r gender1}
gendersubset <- subset(primaries, contbr_gender == 'female' |
                         contbr_gender == 'male')
by_candidate_gender <- group_by(gendersubset, cand_nm, contbr_gender)
contb_totals_election <- summarise(by_candidate_gender,
                                   total = sum(contb_receipt_amt),
                                   n = n())

ggplot(aes(x = cand_nm, y = total, fill = contbr_gender), 
       data = contb_totals_election) +
  geom_bar(stat = 'identity', position = position_dodge()) + 
  scale_y_continuous(labels = comma) +
  scale_fill_discrete(name = 'gender') +
  ggtitle('Total $ Contributed to Each Candidate by Gender') + 
  labs(x = 'candidate name', y = '$ amount of contributions') + 
  theme(plot.title = element_text(face = 'bold', size = 16, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10, angle = 60))
```

This next plot will show the total proportion recieved by each candidate from each gender, to make comparisons easier between men and women. 

To account for differing political preferences across genders (women tend to lean Democratic, men Republican), this next graph will show the proportion of giving to each candidate among *only Republican candidates*. This will allow us to see which Republican candidates resonated better with Republican women/men. We could perhaps expect Carly Fiorina, as the only woman in the field, to have done a bit better among women. Amongst the rest of the candidates, it wouldn't be surprising to see Mr. Trump perform worse among women, as he was frequently called out for misogynistic behavior during the primary race. 

```{r}
by_republican_candidate_gender <- group_by(subset(gendersubset, cand_party == 'Republican'), cand_nm, contbr_gender)
comb_totals_republican <- summarise(by_republican_candidate_gender,
                                   total = sum(contb_receipt_amt),
                                   n = n())

republican_split <- function(row) {
  total <- as.numeric(row[['total']])
  gender <- row[['contbr_gender']]
  return(total/sum(subset(comb_totals_republican, 
                          contbr_gender == gender)$total))
}

comb_totals_republican$proportion <- 
  apply(comb_totals_republican, 1, republican_split)

ggplot(aes(x = cand_nm, y = proportion, fill = contbr_gender), 
       data = comb_totals_republican) +
  geom_bar(stat = 'identity', position = position_dodge()) + 
  scale_y_continuous(labels = comma) +
  scale_fill_discrete(name = 'gender') +
  ggtitle('Proportion of $ Contributed to Each Candidate by Gender') + 
  labs(x = 'candidate name', y = 'proportion of $ amount of contributions') + 
  theme(plot.title = element_text(face = 'bold', size = 16, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10, angle = 60))
```

This is (in my opinion) a rather astounding result! This shows that there is no clear difference between the preferred candidates of Republican men vs. Republican women. Not a single candidate has a difference in support greater than 3%. Without any historical results to compare against, it is impossible to say that this is unprecendented, but I would be shocked to see such an even split across gender in any primary race in recent history.  


### Contributions by Income
In this section we'll examine the relationship between income and contributions. As discussed earlier, we have no way of obtaining data on the individual contributor level, so our analysis here is on the zip code level. 

```{r income1}
#simple plot showing roughly the distro of donations in zips of each income
ggplot(aes(x = agiPC), 
       data = primaries) +
  geom_histogram(binwidth = 5) +
  coord_cartesian(xlim = c(0,200)) +
  ggtitle('# of Contributions by Income of Zipcode') + 
  labs(x = 'AGI per capita of zipcode', y = '# of contributions received') + 
  theme(plot.title = element_text(face = 'bold', size = 16, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10))
```

```{r income2}
#adding in split by party
ggplot(aes(x = agiPC), 
       data = subset(primaries, cand_party %in% c('Democratic',
                                                  'Republican'))) +
  geom_histogram(binwidth = 5, aes(fill = cand_party)) +
  scale_fill_manual(values = partycolors, 
                    guide = guide_legend(title = 'party')) +
  coord_cartesian(xlim = c(0,200)) +
  ggtitle('# of Contributions to Each Party, by Income of Zipcode') + 
  labs(x = 'AGI per capita of zipcode', y = '# of contributions received') + 
  theme(plot.title = element_text(face = 'bold', size = 16, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10))
```

These first two plots simply show the number of contributions received from areas of varying income levels (there are a few high-income outliers not included in the plot). We see that the majority of contributions come from zip codes with income levels below $75K per capita. It's hard to draw conclusions about the number of contributions to Republicans vs. Democrats as income levels change; what is clear is that in terms of the number of contributions made, Democrats received more across the board. 

Using the **quantile** function, we can take a look at the distribution of income by decile:
```{r income deciles}
quantile(primaries$agiPC, prob = seq(0, 1, length = 11), type = 5)
```

Now we'll take a look at the total $ amount contributed to each candidate, looking first at zip codes with an AGI per capita of less than $30,000, and then at zips with an AGI per capita of over $80,000. 

```{r low-income zips}
#normal plots subsetting by lower income zip codes and higher income zips
by_candidate_low <- group_by(subset(primaries,
                                    agiPC < 30 & cand_party %in%
                                      c('Democratic', 
                                        'Republican')), cand_nm)
contb_totals <- summarise(by_candidate_low,
                          total = sum(contb_receipt_amt),
                          n = n())
contb_totals$cand_party <- factor(apply(contb_totals['cand_nm'], 1,
                                     assign_candidate_party))

ggplot(aes(x = cand_nm, y = total),
       data = contb_totals) + 
  geom_bar(stat = 'identity', position = position_dodge(), 
           aes(fill = cand_party)) +
  scale_fill_manual(values = partycolors,
                    guide = guide_legend(title = 'party')) +
  scale_y_continuous(labels = comma) +
  ggtitle('Contributions to Each Candidate, in Low-Income Zipcodes') + 
  labs(x = 'candidate name', y = '$ received') + 
  theme(plot.title = element_text(face = 'bold', size = 16, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10, angle = 60))
```

```{r high-income zips}
by_candidate_high <- group_by(subset(primaries,
                                    agiPC > 80 & cand_party %in%
                                      c('Democratic', 
                                        'Republican')), cand_nm)
contb_totals <- summarise(by_candidate_high,
                          total = sum(contb_receipt_amt),
                          n = n())
contb_totals$cand_party <- factor(apply(contb_totals['cand_nm'], 1,
                                     assign_candidate_party))

ggplot(aes(x = cand_nm, y = total),
       data = contb_totals) + 
  geom_bar(stat = 'identity', position = position_dodge(),
           aes(fill = cand_party)) +
  scale_fill_manual(values = partycolors,
                    guide = guide_legend(title = 'party')) +
  scale_y_continuous(labels = comma) +
  ggtitle('Contributions to Each Candidate, in High-Income Zipcodes') + 
  labs(x = 'candidate name', y = '$ received') + 
  theme(plot.title = element_text(face = 'bold', size = 16, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10, angle = 60))
```

These plots show us that Mr. Sanders does very well among the low-income population, while Mr. Christie and Mr. Bush are stronger in the high-income areas. Ms. Clinton performs well across both demographics. 

In search of a more holistic perspective, below we examine the proportion of $ contributions received by each candidate split by quintile (bottom 20% of incomes, 20% to 40%, etc.).

```{r income4}
income_split <- function(row) {
  total <- as.numeric(row[['total']])
  rank <- as.numeric(row[['incomerank']])
  return(total/sum(subset(income_totals, incomerank == rank)$total))
}

quantiles = as.numeric(quantile(primaries$agiPC, 
                                prob = seq(0, 1, length = 11), type = 5))

primaries$incomerank <- (primaries$agiPC <= quantiles[2])
primaries$incomerank <- primaries$incomerank + 
  (primaries$agiPC <= quantiles[4])
primaries$incomerank <- primaries$incomerank + 
  (primaries$agiPC <= quantiles[6])
primaries$incomerank <- primaries$incomerank + 
  (primaries$agiPC <= quantiles[8])
primaries$incomerank <- 5 - primaries$incomerank

primaries$incomerank <- factor(primaries$incomerank)

by_candidate_income <- group_by(primaries, cand_nm, incomerank)
income_totals <- summarise(by_candidate_income, 
                           total = sum(contb_receipt_amt),
                           n = n())

income_split <- function(row) {
  total <- as.numeric(row[['total']])
  rank <- as.numeric(row[['incomerank']])
  return(total/sum(subset(income_totals, incomerank == rank)$total))
}

income_totals$proportion <- apply(income_totals, 1, income_split)

ggplot(aes(x = cand_nm, y = proportion, fill = incomerank),
       data = income_totals) + 
  geom_bar(stat = 'identity', position = position_dodge()) +
  scale_fill_brewer(palette = 'Greens', 
                    guide = guide_legend(title = 'income quintile')) + 
  theme(panel.background = element_rect(fill = 'rosybrown1')) +
  ggtitle('Proportion of $ to Each Candidate, by Income Quintile of Zipcode') +
  labs(x = 'candidate name', y = 'proportion of $ received') + 
  theme(plot.title = element_text(face = 'bold', size = 12, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10, angle = 60))
```

The results displayed in this plot reinforce the conclusions drawn from the analysis above:  
- Sanders does incredibly well in low-income areas (second only to Clinton in quintiles 1 through 3), while seeing his share of contributions drop precipitously as we go up the income ladder  
- Bush and Christie see the most significant jump in support as we move from low-income to high; Bush receives about 9% of the contributions of the top 20% while receiving less than 5% of the total for the other four quintiles  
- It is perhaps not a strong enough trend to read too much into, but Trump appears to receive a diminishing proportion of contributions as we go up in income, with the exception of the lowest-income areas, which is where he performed worst. This would fit with the characterization of his campaign as one that appealed to working-class voters (primarily white) while failing to resonate with the poorest subset of the population (primarily nonwhite)  
- Clinton's support is consistent across quintiles: her percentage of dollars received is between 29% and 39% for all five groups  
- Most other major candidates see relatively consistent support as well: Ben Carson, Ted Cruz, and Marco Rubio all stayed in a 5% range across the five quintiles  

### Contributions (and Polling) Over Time
Here we will examine the contributions received by the candidates over time, and also analyze the relationship between a candidate's status in the polls and the contributions he or she received. It's plausible that contributions would be either a leading or a lagging predictor of polling (or have no significant relationship whatsoever): in theory, if a canddiate takes in more money they should then be able to spend more on their campaign, which would hopefully increase their standing in the polls. At the same time, perhaps a candidate's strong performance (or weak performance) in the polls would lead to them receiving more (or less) money from donors.  

In this section we'll once again be looking at the Republican primary race, as the Democratic race had only two significant candidates.  

```{r all contribs per day}
#first order of business is cleaning up the dates
primaries$newdates <- as.Date(primaries$contb_receipt_dt,
                             format = '%d-%b-%y')

republican_primaries <- subset(primaries, cand_party == 'Republican')
ggplot(aes(x = newdates, y = contb_receipt_amt),
       data = republican_primaries) +
  geom_bar(stat = 'identity') +
  scale_y_continuous(labels = comma) +
  ggtitle('$ Contributed to Republican Candidates Per Day') + 
  labs(x = 'date', y = '$ contributed') + 
  theme(plot.title = element_text(face = 'bold', size = 16, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10))  

```

The above plot shows contributions per day to Republican candidates over the course of the primary campaign. While it seems like contributions begin ramping up in 2016, it's tough to get a real sense of trends when using such a granular measure of time. Also, our interest is more in examining the trend in contributions to each candidate over time.

One additional note: because we intend to compare contributions vs. poll performance, and our measure of poll performance is national, we will be removing Chris Christie from this portion of the analysis. As a New Jersyan he received a level of contributions that was in no way in line with national averages, and including him would prevent us from drawing any useful conclusions. 

#### Polling data
The polling data I use was obtained from the [Huffington Post Pollster](http://elections.huffingtonpost.com/pollster/api/charts/2016-national-gop-primary'); it is their Pollster average calculated throughout the primary campaign.

Here are the results, after some cleaning. This analysis is limited to seven of the Republican Primary challengers (Trump, Cruz, Kasich, Rubio, Bush, Carson, and Walker). 

```{r polling average, eval=FALSE}
#this code will create the data frame from scratch
rpolls <- fromJSON(paste('http://elections.huffingtonpost.com',
                    '/pollster/api/charts/',
                    '2016-national-gop-primary',
                         sep = ''))
rpolls <- rpolls$estimates_by_date
#rpolls <- read.csv()
rpolldates <- rpolls$date #dates of data
n_dates <- length(rpolldates) #number of dates
rpolls_df <- data.frame(date=as.Date(rpolldates),
                        Trump=double(n_dates),
                        Cruz=double(n_dates),
                        Kasich=double(n_dates),
                        Bush=double(n_dates),
                        Carson=double(n_dates),
                        Christie=double(n_dates),
                        Fiorina=double(n_dates),
                        Graham=double(n_dates),
                        Huckabee=double(n_dates),
                        Jindal=double(n_dates),
                        Pataki=double(n_dates),
                        Paul=double(n_dates),
                        Perry=double(n_dates),
                        Rubio=double(n_dates),
                        Santorum=double(n_dates),
                        Walker=double(n_dates))

for(i in 1:n_dates) {
  datedata <- rpolls[rpolls$date == rpolls_df[i,'date'],]$estimates[[1]]
  for (j in 1:dim(datedata)[1]) {
    name = datedata[j,]$choice
    if (name == 'Rand Paul') { #Rand Paul doesn't have same naming convention
      name = 'Paul'
    }
    if (!(name %in% colnames(rpolls_df))) {
      next
    }
    rpolls_df[i,name] <- datedata[j,]$value
  }
}
```

```{r}
clean_polls <- function(dates, polls, start_date, end_date) {
  n <- length(dates)
  for(i in 1:n) {
    if (dates[i] >= start_date && dates[i] <= end_date) {
      if (polls[i] == 0) {
        end_poll <- polls[i-1]
        j = i
        while(polls[j] == 0) {
          j = j+1
        }
        start_poll <- polls[j]
        inc <- (end_poll - start_poll) / (j - i + 1)
        for (k in i:(j - 1)) {
          polls[k] <- end_poll - inc*(k-i+1)
        }
      }
    }
  }
  return(polls)
}
```


```{r}
rpolls_df <- read.csv('huffpo_pollster.csv')
rpolls_df$X = NULL
rpolls_df$date <- as.Date(rpolls_df$date)

drop_candidates <- c('Fiorina', 'Graham', 'Huckabee', 'Jindal',
                     'Pataki', 'Paul', 'Perry', 'Santorum',
                     'Christie')

rpolls_df_melt_drop <- rpolls_df[,!(names(rpolls_df) %in% drop_candidates)]
rpolls_df_melt <- melt(rpolls_df, id.vars = 'date')
rpolls_df_melt_drop <- melt(rpolls_df_melt_drop, id.vars = 'date')
#this is mostly perfect, but need to fix some missing data 
#(a few go to 0 for a couple of days before they drop out of
#the data and then jump back up before returning to 0)

drop_candidates <- c('Fiorina', 'Graham', 'Huckabee', 'Jindal',
                     'Pataki', 'Paul', 'Perry', 'Santorum',
                     'Christie') 
#these candidates don't get a significant amount of 
#votes/contributions

rpolls_df_clean <- rpolls_df
rpolls_df_clean$date <- as.Date(rpolls_df_clean$date)
rpolls_df_clean$Trump <- clean_polls(rpolls_df_clean$date,
                                     rpolls_df_clean$Trump,
                                     as.Date('2015-03-31'),
                                     as.Date('2015-06-14'))
rpolls_df_clean$Kasich <- clean_polls(rpolls_df_clean$date,
                                      rpolls_df_clean$Kasich,
                                      as.Date('2015-01-31'),
                                      as.Date('2015-12-14'))
rpolls_df_clean$Walker <- clean_polls(rpolls_df_clean$date,
                                      rpolls_df_clean$Walker,
                                      as.Date('2015-09-21'),
                                      as.Date('2015-10-04'))
rpolls_df_clean$Bush <- clean_polls(rpolls_df_clean$date,
                                    rpolls_df_clean$Bush,
                                    as.Date('2016-02-21'),
                                    as.Date('2016-02-24'))
rpolls_df_clean$Rubio <- clean_polls(rpolls_df_clean$date,
                                     rpolls_df_clean$Rubio,
                                     as.Date('2016-03-16'),
                                     as.Date('2016-03-20'))
rpolls_df_melt_drop <- 
  rpolls_df_clean[,!(names(rpolls_df_clean) %in% drop_candidates)]
rpolls_df_melt_drop <- melt(rpolls_df_melt_drop, id.vars = 'date')

ggplot(aes(x = date, y = value, color = variable),
       data = rpolls_df_melt_drop) + 
  geom_line() +
  ggtitle('HuffPost Pollster Average for Republican Primary (national)') + 
  labs(x = 'date', y = 'polling average') + 
  theme(plot.title = element_text(face = 'bold', size = 16, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10))
```

```{r republican contribs}
#by_date <- group_by(primaries, newdates, cand_nm)
#date_totals <- summarise(by_date,
#                         total = sum(contb_receipt_amt),
#                         n = n())

#this is what i'm trying to figure out::
uniquedates <- unique(republican_primaries$newdates)
n_uniquedates <- length(uniquedates) #number of unique dates

#data frame we will use for the rest of this analysis
republican_contribs <- data.frame(date=as.Date(uniquedates),
                        Trump=double(n_uniquedates),
                        Cruz=double(n_uniquedates),
                        Kasich=double(n_uniquedates),
                        Bush=double(n_uniquedates),
                        Carson=double(n_uniquedates),
                        Christie=double(n_uniquedates),
                        Fiorina=double(n_uniquedates),
                        Graham=double(n_uniquedates),
                        Huckabee=double(n_uniquedates),
                        Jindal=double(n_uniquedates),
                        Pataki=double(n_uniquedates),
                        Paul=double(n_uniquedates),
                        Perry=double(n_uniquedates),
                        Rubio=double(n_uniquedates),
                        Santorum=double(n_uniquedates),
                        Walker=double(n_uniquedates))

n_contbs <- dim(republican_primaries)[1] 
#number of rows in our contribution data
#this takes a few minutes
#we are tracking the contributions for each candidate on 
#each day in the dataset
#then, we are adding the contributions received over the ensuing 
#two weeks as well, in order to smooth the graph
for(i in 1:n_contbs) {
  contb_amt <- republican_primaries[i,'contb_receipt_amt']
  candidate <- as.character(republican_primaries[i,'cand_nm'])
  contb_date <- republican_primaries[i,'newdates']
  republican_contribs[republican_contribs$date == contb_date,
                      candidate] <- 
    republican_contribs[republican_contribs$date == contb_date,
                      candidate] + contb_amt
  #add to next two weeks of dates as well
  for (j in 1:13) {
    tryCatch(republican_contribs[republican_contribs$date == (contb_date + j),
                      candidate] <-
               republican_contribs[republican_contribs$date ==
                                     (contb_date + j), candidate] +
               contb_amt, error = function(e) break)
  }
}

#we add on a 'total' variable
republican_contribs <- mutate(republican_contribs, 
                              total = Trump + Cruz + Kasich + 
                                Bush + Carson + Fiorina + Graham +
                                Huckabee + Jindal + Pataki + Paul +
                                Perry + Rubio + Santorum + Walker) 
#leaving out Christie
republican_contribs[,2:17] <- 
  republican_contribs[,2:17]/republican_contribs[,18]
republican_contribs_melt <- republican_contribs
republican_contribs_melt$Christie <- NULL #remove Christie column
republican_contribs_melt$total <- NULL #remove total column
drop_candidates <- c('Fiorina', 'Graham', 'Huckabee', 'Jindal',
                     'Pataki', 'Paul', 'Perry', 'Santorum',
                     'Christie') 
#these candidates don't get a significant amount of votes/contributions
republican_contribs_melt_drop <-
  republican_contribs_melt[,
                           !(names(republican_contribs_melt) %in%
                               drop_candidates)]
republican_contribs_melt <- melt(republican_contribs_melt, id.vars = 'date')
republican_contribs_melt_drop <-
  melt(republican_contribs_melt_drop, id.vars = 'date')
```

####Contribution Data

To arrive at the (admittedly messy) plot below, I summed up each candidate's contributions received for a two-week rolling period throughout the dataset. This was then converted into a proportion, to make these values more easily comparable to polling numbers. 

```{r top republicans contrib}
ggplot(aes(x = date, y = value, color = variable),
       data = subset(republican_contribs_melt_drop, 
                     date <= as.Date('2016-07-01'))) + 
  geom_line() +
  ggtitle('Proportion of $ Received Throughout Primary') + 
  labs(x = 'date', y = 'proportion') + 
  theme(plot.title = element_text(face = 'bold', size = 16, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10))
```

Some notes on each candidate:  
- **Trump** never had higher than 10% or so of donations until the point when Cruz and Kasich abandoned the race.  
- **Cruz's** standing clearly improves throughout the race as he emerged as the primary alternative to Trump  
- **Kasich** was not much of a player for most of the race, but we can see contributions start to pour in after Rubio (considered the most viable mainstream candidate for most of the race) dropped out!    
- **Bush** was receiving the most money early on in the race, and remained near the top - along with Cruz and Rubio - right up until he dropped out of the race after weak showings in Iowa and New Hampshire  
- **Carson** caught fire rather unexpectedly, and was getting the most contributions for a period in late 2015  
- **Rubio** was consistently at the top of the field in contributions until dropping off after a weak performance in the early states. He kept getting money in the run-up to Super Tuesday, but dropped out after failing to even win his home state of Florida  
- **Walker** was a leading candidate in the early months of the race, but perhaps had considerably more foresight than the others and dropped out before the calendar even hit 2016  

```{r, results = FALSE}
#this code puts the polling and contribution data into one uniform data frame, so the two series can be shown on the same plot
#rpolls_df
#republican_contribs

#sort(unique(rpolls_df$date)) #1/12/15 to 5/8/16
#sort(unique(republican_contribs$date)) #2/10/15 to 8/22/16
unif_rpolls_df <- subset(rpolls_df, date >= '2015-02-15')
unif_republican_contribs <- subset(republican_contribs, date <= '2016-05-08')

#unique(unif_rpolls_df$date)
#unique(unif_republican_contribs$date)
unif_republican_contribs$total = NULL
unif_rpolls_df <- unif_rpolls_df[,
                                 !(names(unif_rpolls_df) %in%
                                     drop_candidates)]
unif_republican_contribs <-
  unif_republican_contribs[,!(names(unif_republican_contribs) 
                              %in% drop_candidates)]

unif_rpolls_df <- melt(unif_rpolls_df, id.vars = 'date')
unif_republican_contribs <- 
  melt(unif_republican_contribs, id.vars = 'date')

unif_rpolls_df$value <- unif_rpolls_df$value/100
```

```{r}
contrib_vs_polls <- function(candidate, cand_color = 'tan3',
                             title_override = FALSE){
  if (title_override) {
    title <- candidate
  } else {
    title <- paste(candidate,
                   ': Proportion of $ Received and Polling Throughout Primary')
  }
  polls <- subset(unif_rpolls_df, variable == candidate)
  contribs <- subset(unif_republican_contribs, variable == candidate)
  scale_factor <- max(contribs$value)/max(polls$value)
  
  return(ggplot() + 
  geom_line(aes(x = date, y = value*scale_factor), 
            data = subset(unif_rpolls_df, variable == candidate),
            linetype = 2, color = cand_color) +
  geom_line(aes(x = date, y = value),
            data = subset(unif_republican_contribs,
                          variable == candidate), 
            color = cand_color) +
  ggtitle(title) + 
  labs(x = 'date') +
  scale_y_continuous('contribution %', 
                     sec.axis = sec_axis(~ . / scale_factor, 
                                         name = 'polling %')) +
  theme(plot.title = element_text(face = 'bold', size = 16, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10, angle = 60)))
}

```

### Polling % vs. Contribution %
This section is intended more as a soft examination than a rigorous analysis, but a perfunctory look at the results leads one to believe that money typically follows the polling numbers, vs. driving them.  

In the plots below, the axes have been scaled so the maxima of both series are line up on the plot. The dotted lines are the polling average - measured on the right axis - and the solid lines are the contribution average - measured on the left axis. 

```{r}
#this plots the series for all 7 candidates
keep_candidates <- c('Trump', 'Cruz', 'Kasich', 'Bush',
                     'Carson', 'Rubio', 'Walker')
candidate_colors <- c('firebrick', 'darkorange', 'darkgoldenrod',
                      'forestgreen', 'aquamarine', 'dodgerblue',
                      'orchid')
for (i in 1:length(keep_candidates)) {
  plot <- contrib_vs_polls(keep_candidates[i], 
                           cand_color = candidate_colors[i],
                           title_override = TRUE)
  print(plot)
}

```

####Conclusions: 
**Trump** is such a unique case that it is hardly worth discussing, as he did not receive a significant proportion of the contributions until most of the other candidiates dropped out.  
For both **Cruz** and **Kasich**, we see their contribution numbers trend upwards towards the end of the campaign, but this trend gets started a week or two later than the polling numbers.  
**Carson** picked up contributions as his poll numbers climbed towards the end of 2015, but then quickly saw them drop off as his polling numbers did the same. 
**Rubio**, who endured a few ups and downs during the race, saw the same reflectd in his contribution numbers. It typically appeared that more money started rolling in after he began to rally back in the polls. 

### 'Switch' Voters
Donald Trump and Hillary Clinton were the two most unpopular presidential candidates of the modern era. Thus it should not come as much surprise that there were some who refused to support Trump in the general election after contributing to the primary campaigns of other Republicans, and also some who supported Bernie Sanders in the Democratic Primary and then supported Trump in the general election (despite their chasmic differences in policy positions).   

In this section we'll put some numbers behind these "switch" voters.  

####Sanders to Trump  
Bernie Sanders and Donald Trump both relied on a 'populist' and 'outsider' appeal in order to garner support, though they obvious drew on that support in different ways. How many Sanders supporters decided they would rather support the 'outsider' candidate - Trump - in the general election, rather than Clinton, the candidate whose policies aligned much more with those of Sanders?  

The plots below show the answer to that question is "not many".  

```{r Sanders to Trump}
#donors to Sanders in the primary
berniebros <- subset(primaries, cand_nm == 'Sanders')
berniebrosgen <- subset(general, contbr_nm %in% berniebros$contbr_nm)
berniebrossum <- group_by(berniebrosgen, cand_nm)
berniegeneral <- summarise(berniebrossum, 
                           total = sum(contb_receipt_amt),
                           n = n())

ggplot(aes(x = cand_nm, y = total),
        data = berniegeneral) +
  geom_bar(stat = 'identity', aes(fill = cand_nm)) +
  scale_fill_manual(values = candcolors) +
  scale_y_continuous(labels = comma) +
  ggtitle("Contributions in the General Election from Sanders' Supporters") + 
  labs(x = 'candidate', y = '$ contributed') + 
  theme(plot.title = element_text(face = 'bold', size = 12, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10)) +
  theme(legend.position = 'none')

```

```{r number of contributions}
ggplot(aes(x = cand_nm, y = n),
        data = berniegeneral) +
  geom_bar(stat = 'identity', aes(fill = cand_nm)) +
  scale_fill_manual(values = candcolors) +
  scale_y_continuous(labels = comma) +
  ggtitle("Contributions in the General Election from Sanders' Supporters") + 
  labs(x = 'candidate', y = '# of contributions') + 
  theme(plot.title = element_text(face = 'bold', size = 12, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10)) +
  theme(legend.position = 'none')
```

We show both the $ amount of contributions and the raw number of individual contributions, because Bernie received a huge amount of support from low-income individuals who often gave donations in the range of five dollars. Both plots look effectively the same. Trump received almost no support from those who had contributed to Sanders in the primary.  

In fact, there were only 4 different people who fit this description (the top two are the same person; names not included in this display):

```{r who were they}
sanderstotrump <- subset(berniebrosgen, cand_nm == 'Trump')
sanderstotrump[,c('contbr_city', 'contbr_employer',
                  'contbr_occupation', 'contb_receipt_amt')]
```

#### Non-Trump Republicans to...?
As a completely uncovnentional, non-establishment candidate, Trump drew the ire of many traditional Republicans. But would those who didn't give to him at any point in the primary race fall in line for the general election?  

The plots below give a complicated answer. In the first plot we see that it looks like the majority of Republicans who gave to other candidates in the primary also gave to Trump in the general; at the same time, it is certainly worth noting that Hillary received a substantial amount of support from Republicans, especially compared to the support Trump received from former-Sanders contributors.  

But the second plot tells a bit of a different story. In terms of number of contributions received, Clinton outdid Trump by greater than a 3:1 margin. What story does this tell us? Well, perhaps the Republicans who were most likely to fall in line and support Trump were those who tended to be the biggest Republican supporters in dollar-terms - i.e. those who generally use their contributions as a way of maintaining some degree of influence in the party, and thus would not want to relinquish that influence regardless of if the candidate tended to support traditional Republican ideals. 

```{r}
nevertrumpers <- subset(primaries,
                        (cand_party == 'Republican' & cand_nm != 'Trump'))
nevertrumpersgen <- subset(general, contbr_nm %in% nevertrumpers$contbr_nm)
nevertrumperssum <- group_by(nevertrumpersgen, cand_nm)
nevertrumpersgeneral <- summarise(nevertrumperssum,
                                  total = sum(contb_receipt_amt),
                                  n = n())
#can remove this for final run:
nevertrumpersgen$newdates <- as.Date(nevertrumpersgen$contb_receipt_dt,
                             format = '%d-%b-%y')

#removing donations from before Trump effectively clinched 
#nomination (when Cruz and Kasich dropped out), because many 
#donations are classified as 'general' instead of 'primary' even 
#though they occurred during the primaries
nevertrumpersgen <- subset(nevertrumpersgen, newdates >= '2016-05-04')
nevertrumperssum <- group_by(nevertrumpersgen, cand_nm)
nevertrumpersgeneral <- summarise(nevertrumperssum,
                                  total = sum(contb_receipt_amt),
                                  n = n())
ggplot(aes(x = cand_nm, y = total),
       data = nevertrumpersgeneral) +
  geom_bar(stat = 'identity', aes(fill = cand_nm)) +
  scale_fill_manual(values = candcolors) +
  scale_y_continuous(labels = comma) +
  ggtitle(paste("Contributions in the General Election from ",
                "Originally Non-Trump Republican Supporters",
                sep = '')) + 
  labs(x = 'candidate', y = '$ contributed') + 
  theme(plot.title = element_text(face = 'bold', size = 10, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10)) +
  theme(legend.position = 'none')
```

```{r}
ggplot(aes(x = cand_nm, y = n),
       data = nevertrumpersgeneral) +
  geom_bar(stat = 'identity', aes(fill = cand_nm)) +
  scale_fill_manual(values = candcolors) +
  scale_y_continuous(labels = comma) +
  ggtitle(paste("Contributions in the General Election from ",
                "Originally Non-Trump Republican Supporters",
                sep = '')) + 
  labs(x = 'candidate', y = '# of contributions') + 
  theme(plot.title = element_text(face = 'bold', size = 10, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10)) +
  theme(legend.position = 'none')
```

To get a more concrete sense of this, we can look at the distributions of the $ amount of these donations: 

```{r}
ggplot(aes(x = contb_receipt_amt), 
       data = nevertrumpersgen) + 
  geom_histogram(binwidth = 50, aes(fill = cand_nm)) +
  scale_fill_manual(values = candcolors, 
                    guide = guide_legend(title = 'candidate')) +
  coord_cartesian(xlim = c(0, 1000)) +
  ggtitle(paste("Contributions in the General Election from ",
                "Originally Non-Trump Republican Supporters",
                sep = '')) + 
  labs(x = 'size of contribution', y = '# of contributions') + 
  theme(plot.title = element_text(face = 'bold', size = 10, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10))

```

Most of Clinton's contributions are < $150, whereas most of Trump's are larger than this. 

### By Zip Code
In this final section, we will look at contribution data by zip code, with some geographical visualizations.  

Using the [**'maps'**](https://cran.r-project.org/web/packages/maps/maps.pdf) and [**'zipcode'**](https://cran.r-project.org/web/packages/zipcode/zipcode.pdf) packages, it is rather straightforward to draw maps of New Jersey that display the data we have collected on contributions by zip code.  

The plots below all show different measures of contributions broken out by zip code. The zip codes are grouped into three income groups, 'high', 'middle', and 'low'. These are, roughly, the top 10%, middle 80%, and bottom 10% of incomes, respectively.  

This first plot shows total $ contributed by zip code. A few things jump out immediately. First: the red dots (low income) are mostly clustered in a few areas: Trenton and Camden in the western part of the state, and Newark, Jersey City, and the other surrounding cities on the outskirts of New York in the northeast. Aside from one red dot in the southeastern part of the dates, the red dots are all quite small. This isn't surprising - one would expect less money to come from poorer areas - but it serves to suggest that lower-income people find it more difficult to make their voices heard in the political process. As they say, "money talks".

```{r zipcodes}
library(maps)
njmap <- map_data('state', region = 'new jersey')
#install.packages('zipcode')
library(zipcode)
data(zipcode)
zipcodenj <- subset(zipcode, state == 'NJ')
slimnjincome$cleanzip <- clean.zipcodes(slimnjincome$ZIPCODE)
zipcodenj <- merge(zipcodenj, slimnjincome, by.x = 'zip', by.y = 'cleanzip')

byzipcode <- group_by(primaries, cleaned_zips)
byzipcodetotals <- summarise(byzipcode, 
                             total = sum(contb_receipt_amt),
                             n = n())
byzipcodetotals$cleanzip <- clean.zipcodes(byzipcodetotals$cleaned_zips)
zipcodenj <- merge(zipcodenj, byzipcodetotals, 
                   by.x = 'zip', by.y = 'cleanzip')

zipcodenj$incomegroup <- 'middle'
zipcodenj[zipcodenj$agiPC < 20,]$incomegroup <- 'low'
zipcodenj[zipcodenj$agiPC > 78,]$incomegroup <- 'high'
zipcodenj$incomegroup <- factor(zipcodenj$incomegroup)

#add some cities to the plots, for context
cities <- data.frame(city = c('Newark', 'Camden','Trenton', 'Paterson'))
cities <- cbind(geocode(as.character(cities$city)),cities)

```

```{r}
ggplot(data = njmap, aes(x = long, y = lat)) +
  geom_polygon(color = 'black', fill = NA) +
  coord_map() +
  geom_point(data = zipcodenj, 
             aes(x = longitude, y = latitude, 
                 color = incomegroup, size = total), 
             alpha = .7) +
  scale_color_manual(values = incomecolors, name = 'income group') +
  labs(x = NULL, y = NULL) +
  scale_x_continuous(breaks = NULL) +
  scale_y_continuous(breaks = NULL) +
  ggtitle('$ Contbribution by Zip Code') +
  theme(plot.title = element_text(face = 'bold', size = 16, hjust = .5)) +
  scale_size(name = '$ Contributed', 
             labels = comma, guide = guide_legend(reverse = TRUE))
```

Here we show the same plot but with the middle income group removed, to accentuate the difference between the highest-income and lowest-income areas. It is easier to see the many large blue dots and many tiny red dots. For added context, four of New Jersey's largest cities are labeled (note, they are each represented by a cluster of red dots).

```{r}
ggplot(data = njmap, aes(x = long, y = lat)) +
  geom_polygon(color = 'black', fill = NA) +
  coord_map() +
  geom_point(data = subset(zipcodenj, incomegroup != 'middle'),
             aes(x = longitude, y = latitude, color = incomegroup,
                 size = total), 
             alpha = .7) +
  scale_color_manual(values = incomecolors, name = 'income group') +
  labs(x = NULL, y = NULL) +
  scale_x_continuous(breaks = NULL) +
  scale_y_continuous(breaks = NULL) +
  ggtitle('$ Contbribution by Zip Code') +
  theme(plot.title = element_text(face = 'bold', size = 16, hjust = .5)) +
  scale_size(name = '$ Contributed', 
             labels = comma, guide = guide_legend(reverse = TRUE)) +
  geom_text(data = cities, aes(x = lon, y = lat, label = city,
                               vjust = -1, fontface = 2),
            show.legend = FALSE)
```

Given the inherent disparity in income between these two groups, it might be more interesting to look at the number of individual contributions, instead of the dollar amount given. This could show that people in lower-income areas aren't necessarily less politically involved, just less capable of giving a lot of money. 

```{r}
ggplot(data = njmap, aes(x = long, y = lat)) +
  geom_polygon(color = 'black', fill = NA) +
  coord_map() +
  geom_point(data = subset(zipcodenj, agiPC < 20 | agiPC > 78),
             aes(x = longitude, y = latitude,
                 color = incomegroup, size = n),
             alpha = .7) +
  scale_color_manual(values = incomecolors, name = 'income group') +
  labs(x = NULL, y = NULL) +
  scale_x_continuous(breaks = NULL) +
  scale_y_continuous(breaks = NULL) +
  ggtitle('# of Contbributions by Zip Code') +
  theme(plot.title = element_text(face = 'bold', size = 16, hjust = .5)) +
  scale_size(name = '# of Contributions',
             labels = comma, guide = guide_legend(reverse = TRUE)) +
  geom_text(data = cities, aes(x = lon, y = lat, label = city,
                               vjust = -1, fontface = 2),
            show.legend = FALSE)
```

This hypothesis is to some extent borne out in the plot: while the largest dots still come from the high-income group, there are more midsize red dots than there were previously.  

The last plot, shown below, is our final attempt to put these two groups on an even playing field. The size of the dots here is based on the total $ contributed in each zip code divided by the adjusted gross income per capita of the zip code. 

```{r}
ggplot(data = njmap, aes(x = long, y = lat)) +
  geom_polygon(color = 'black', fill = NA) +
  coord_map() +
  geom_point(data = subset(zipcodenj, agiPC < 20 | agiPC > 78),
             aes(x = longitude, y = latitude,
                 color = incomegroup, size = total/(agiPC*1000)),
             alpha = .7) +
  scale_color_manual(values = incomecolors, name = 'income group') +
  labs(x = NULL, y = NULL) +
  scale_x_continuous(breaks = NULL) +
  scale_y_continuous(breaks = NULL) +
  ggtitle('$ Contributed per average Adjusted Gross Income by Zip Code') +
  theme(plot.title = element_text(face = 'bold', size = 10, hjust = .5)) +
  scale_size(name = '$ Contributed / AGI per capita',
             labels = comma, guide = guide_legend(reverse = TRUE)) +
  geom_text(data = cities, aes(x = lon, y = lat, label = city,
                               vjust = -1, fontface = 2),
            show.legend = FALSE)
```

This plot shows more parity between the two groups than any that we have shown prior. It's a hopeful message! And not completely intuitive - I personally wouldn't expect that the lowest-income segment of the population would give a rougly equal proportion of their income to political campaigns as the highest-income does. Yet that is what we see here. 

##Conclusions 
With such a wide-ranging survey of a dataset, it is difficult to tie all of the findings into a neat conclusion. However, I think it is fair to say that a main takeaway from this analysis is that the characterizations - by the media, general public, etc. - of the candidates and their respective supporters during the course of campaign largely match up with what we see in the data. Bernie Sanders, the uber-liberal socialist candidate with a mean streak towards Wall Street, had the lowest median campaign contribution, performed best in the lower-income zip codes, and received barely any money from workers in the banking industry. Jeb Bush, the establishment Republican candidate, was disproportionately popular among workers in the banking industry and had the highest median contribution of any significant candidate. Hillary Clinton was able to meld the working-class appeal of Sanders (she had the second-lowest median contribution) with the upper-class appeal of Bush (she received by far the most money from banking workers); her support was remarkably consistent across different income levels.   
This is shown once again in the plot below. 

```{r}
ggplot(aes(x = cand_nm, y = proportion, fill = incomerank),
       data = income_totals) + 
  geom_bar(stat = 'identity', position = position_dodge()) +
  scale_fill_brewer(palette = 'Greens', 
                    guide = guide_legend(title = 'income quintile'),
                    labels = c('[0%, 20%]',
                               '(20%, 40%]',
                               '(40%, 60%]',
                               '(60%, 80%]',
                               '(80%, 100%]')) + 
  theme(panel.background = element_rect(fill = 'rosybrown1')) +
  ggtitle('Proportion of Money to Each Candidate, by Income Quintile of Zipcode') +
  labs(x = 'candidate name', y = 'proportion of money received') + 
  theme(plot.title = element_text(face = 'bold', size = 12, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10, angle = 60))
```

Yet there were some unexpected findings in this analysis. We found that there was almost no difference in support during the Republican primary between men and women: both gave roughly equal proportions of their overall contributions to each candidate. I certainly expected, if nothing else, to see Carly Fiorina outperform among Republican women (as Hillary outperformed among Democratic women), and to see Donald Trump outperform among the men. Neither of those hypotheses was borne out in the data, replicated once again below.

```{r}
ggplot(aes(x = cand_nm, y = proportion, fill = contbr_gender), 
       data = comb_totals_republican) +
  geom_bar(stat = 'identity', position = position_dodge()) + 
  scale_y_continuous(labels = comma) +
  scale_fill_discrete(name = 'gender') +
  ggtitle('Proportion of Money Contributed to Each Candidate by Gender') + 
  labs(x = 'candidate name', y = 'proportion of total money contributed') + 
  theme(plot.title = element_text(face = 'bold', size = 12, hjust = .5)) + 
  theme(axis.text.x = element_text(size = 10, angle = 60))
```

And finally, we'll end on an optimistic note. Below is the final plot from our section on zip codes, which showed that there is not a large disparity from the proportion of income contributed to campaigns by the lowest 10% of incomes and the highest 10%. Obviously, if the top 10% and the bottom 10% each give the same proportion of their income, there is still a *lot* more money coming from the wealthiest in society. But I find it encouraging that, apparently, there is a relatively consistent belief across the economic levels of our society that the political process is important and worth contributing to. 

```{r}
ggplot(data = njmap, aes(x = long, y = lat)) +
  geom_polygon(color = 'black', fill = NA) +
  coord_map() +
  geom_point(data = subset(zipcodenj, agiPC < 20 | agiPC > 78),
             aes(x = longitude, y = latitude,
                 color = incomegroup, size = total/(agiPC*1000)),
             alpha = .7) +
  scale_color_manual(values = incomecolors, name = 'income group') +
  labs(x = NULL, y = NULL) +
  scale_x_continuous(breaks = NULL) +
  scale_y_continuous(breaks = NULL) +
  ggtitle('Dollars Contributed per average Adjusted Gross Income by Zip Code') +
  theme(plot.title = element_text(face = 'bold', size = 8, hjust = .5)) +
  scale_size(name = 'Dollars Contributed / AGI per capita',
             labels = comma, guide = guide_legend(reverse = TRUE)) + 
  geom_text(data = cities, aes(x = lon, y = lat, label = city,
                               size = 1.5, vjust = -1,
                               fontface = 2), show.legend = FALSE)
```

##Summary of Analysis and Reflections
While this was, as I said, a far-reaching analysis of this dataset, there is still a lot more room for exploration! One thing in particular that I would like to examine further is how the contributions change across different age groups - one way of approximating this would be to split by the occupation of the contributors; we could look at retirees, students, and then all the other jobs in the middle, as a rough estimate of "old", "young", and "middle-aged". I'd also like to dive deeper into how the contributions varied across the state geographically. 

However, I am generally very pleased with the results here. In most cases the data matched up with the conventional wisdom, and I find that quite encouraging! To me that shows that the media did a pretty good job covering the campaigns. The data from the FEC was relatively easy to work with, although some of the fields - the employer/occupation-related data, in particular - were too messy to merit much use. The most challenging part of the entire analysis, for me, was creating and plotting the rolling average of contributions over time against the polling averages. It was a bit of a nightmare to create the data frames in the first place and also a pain to clean them up! And after all of that work, it isn't something that we're able to draw a concrete conclusion from, which is a bit disappointing. I still think the graphs are visually fun though! And they do tell a story. Throughout the report, I did my best to use an array of different visualization techniques - the time series plots, boxplots, histographs, map plots, etc. - and I hope that contributed positively to the reader's experience. 